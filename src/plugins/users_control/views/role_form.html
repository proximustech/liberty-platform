<script>
    app.module_data.role_form={}
    app.module_data.role_form.role=JSON.parse(`<%- JSON.stringify(role) %>`)
    app.module_data.role_form.roleValidateSchema = JSON.parse(`<%- JSON.stringify(roleValidateSchema).replaceAll("\\","\\\\") %>`)
    eval(`<%- roleValidateFunction %>`)

    app.module_data.role_form.rolePermissions = JSON.parse(`<%- JSON.stringify(rolePermissions) %>`)
    eval(`<%- userHasPermissionOnElement %>`)

    app.module_data.permissionsSchema = {}

    app.module_data.renderPluginSchemaConfig = (pluginName,pluginSchemaConfig) => {
        let permissionsHTML = ""
        pluginSchemaConfig.schema.forEach(permissionConfig => {
            permissionsHTML += `
            <div class="alert alert-primary" role="alert">
                <strong>${permissionConfig.resource.charAt(0).toUpperCase() + permissionConfig.resource.slice(1)}: </strong><br>

            `
            permissionConfig.permissions.forEach(permission => {
                let checked = ""
                if (app.module_data.role_form.userHasPermissionOnElement(app.module_data.role_form.rolePermissions,[`${pluginName}.${permissionConfig.resource}`],[permission])) {
                    checked = "checked"
                }

                permissionsHTML += `
                    <input id="${pluginName}.${permissionConfig.resource}" type="checkbox" data-role="permission" value="${permission}" ${checked}> ${permission.charAt(0).toUpperCase() + permission.slice(1)} <br>
                `
            });
            permissionsHTML += "</div>"
        });
        let element = document.createElement("div");
        element.innerHTML = `
            <sl-details summary="${pluginSchemaConfig.label}">
                ${permissionsHTML}
            </sl-details>        
        `
        document.getElementById("permissions").appendChild(element)
    }    
   
    function submitRole(triggerElement) {

        let role = app.module_data.role_form.role
        let roleValidationResult = app.module_data.role_form.roleValidateFunction(role,app.module_data.role_form.roleValidateSchema)
       
        if (roleValidationResult.isValid) {

            let permissionElements = Array.from(document.querySelectorAll('[data-role="permission"]'))
            let permissions = []
            permissionElements.forEach(element => {
                permissions.push({"resource":element.id,"permission":element.value,"enabled":element.checked})
            });

            role.permissions=permissions

            app.setElementForPendingOperation(triggerElement)
            let result = $.ajax({
                type:"POST",
                url:"<%= prefix %>/role",
                data:"json="+JSON.stringify(role),
                processData: false,
                dataType:"text"
            })
            .done(function() {
                setTimeout(() => {
                    app.ajax('content_view', '/<%= prefix %>/roles')
                    app.drawer.hide();
                    app.toastShow('Saved','Role saved successfully.',{type:"info"})           
                    
                }, 1000);
            })
            .fail(function(data) {
                try {
                    app.unsetElementForPendingOperation(triggerElement)
                    for (messageData of JSON.parse(data.responseText).messages) {
                        app.toastShow('Form data Error',messageData.message,{type:"error"})
                        break;
                    }

                } catch (error) {}
            })
            .always(function() {
            });              
        } else {
            try {
                app.toastShow('Form data Error',roleValidationResult.messages[0].message,{closable:true,type:"error"})
            } catch (error) {}
        }

      
    }

    function deleteRole(uuid) {
        let result = $.ajax({
            type:"DELETE",
            url:"<%= prefix %>/role?uuid="+uuid,
        })
        .done(function() {      
            setTimeout(() =>{
                app.setViewForPendingOperation('content_view')
                htmx.ajax('GET', '/<%= prefix %>/roles', {target:'#content_view', swap:'innerHTML'})
                app.drawer.hide();
                app.dialog.hide()
                app.toastShow('Deleted','Role deleted successfully.',{type:"info"}) 
            },1000)   
        })
    
    }    

</script>
<% if (!editing) { %>
    <h3>Create Role</h3>
<% } else { %>
    <sl-alert open>
        <strong>Editing Role</strong><br />
        <%= role.name %>
      </sl-alert>

<% } %>
    <sl-tab-group id="role_form_tab_group">
        <sl-tab slot="nav" panel="general">General</sl-tab>
        <sl-tab slot="nav" panel="permissions">Permissions</sl-tab>
        <% if (editing) { %>
            <sl-tab slot="nav" panel="operations">Operations</sl-tab>
         
        <% } %>
    
        <sl-tab-panel name="general"> 
            <%- roleFieldRender("role","name",role.name,roleMetadata.name) %>          
        </sl-tab-panel>
        <sl-tab-panel id="permissions" name="permissions">
            <%- permissionsModulesContent %> 
        </sl-tab-panel>

        <% if (editing) { %>
            <sl-tab-panel name="operations">
                <sl-details summary="Delete">
                    <button type="button" class="btn btn-outline-danger" onclick="app.confirmDelete('Delete Role','Are you sure to delete the role <strong><%= role.name %></strong> ?','deleteRole(`<%= role.uuid %>`)')"><i class="bi bi-trash-fill"></i> Delete Role</button>
                    <br>
                </sl-details>
    
            </sl-tab-panel>
         
        <% } %>
        
    </sl-tab-group>

    <div slot="footer" style="padding: 20px;background-color: aliceblue;border-bottom-left-radius: 10px;border-bottom-right-radius: 10px;">
        <button type="button" class="btn btn-secondary" onclick="app.drawer.hide()">Close</button>
        <button type="button" class="btn btn-primary" onclick="submitRole(this)">Save</sl-button>
    </div>

<script>
    document.getElementById('role_form_tab_group').show('general')

    for (const [pluginName, pluginSchemaConfig] of Object.entries(app.module_data.permissionsSchema)) {
        app.module_data.renderPluginSchemaConfig(pluginName,pluginSchemaConfig)
    }

</script>
